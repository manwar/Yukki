#!/usr/bin/env perl
use 5.12.1;

use Yukki;

use Git::Repository;

my $repo_name   = shift;
my $remote_repo = shift;

my $app = Yukki->new;

my $config = $app->settings->{repositories}{ $repo_name };

my $repo_dir = ''.$app->locate('repository_path', $config->{repository});

my $git = Git::Repository->new( git_dir => $repo_dir );

if (defined $remote_repo) {
    $git->run('clone', '--mirror', $remote_repo, $repo_dir);
}

else {
    my $title  = $config->{name} // ucfirst($repo_name);
    my $page   = $config->{default_page} // 'main.yukki';
    my $branch = $config->{site_branch} // 'refs/heads/master';

    my $stub_main = <<END_OF_STUB_MAIN;
# $title

Welcome to your new wiki repository. The first thing you will probably
want to do is edit this page.

Cheers.

END_OF_STUB_MAIN

    $git->run('init', '--bare', $repo_dir);

    my $object_id = $git->run('hash-object', '-t', 'blob', '-w', '--stdin', '--path', $page, { input => $stub_main });

    my $stub_tree = "100655 blob $object_id\t$page\n";
    my $tree_id   = $git->run('mktree', { input => $stub_tree });
    my $commit_id = $git->run('commit-tree', $tree_id, 
        { input => 'Initializing empty Yukki repository.' });

    $git->run('update-ref', $branch, $commit_id, '0' x 40);
}
